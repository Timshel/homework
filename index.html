<!DOCTYPE html>
<html>
<head>
    <META HTTP-EQUIV="EXPIRES" CONTENT="Mon, 22 Jul 2012 11:12:01 GMT">
    <title>Repo browser</title>
	<link rel="stylesheet" href="css/styles.css" />
</head>
<body>
	<header>
		<label>Search a repository</label>    
		<input type="text" id="repoTitle" />
		<p id="resultTitle"></p>
	</header>
	<div id="resultDiv" ></div>
	<div id="displayInfo" >
		<div id="resultCollaborator">		   
		    <a href="https://github.com/killerswan" >
                <img src="https://secure.gravatar.com/avatar/15d216c90aee266d3988fdb87a0b1053?s=140&d=https://a248.e.akamai.net/assets.github.com%2Fimages%2Fgravatars%2Fgravatar-140.png" title="Kevin Cantu"/>
            </a>
	    </div>
	</div>

	<script type="text/template" id="tpl-repository-resultats">
		Hello, searching : <%=name%>, Results : <%=nbResultats%>
	</script>
	
	<script type="text/template" id="tpl-repository-list-item">
		<ul>
			<li>Name : <a href="<%=url%>"><%=name%></a></li>
			<li>Owner : <a href="https://github.com/<%=owner%>"><%=owner%></a></li>
			<li>Watchers : <%=watchers%></li>
		</ul>
	</script>
	
	<script type="text/template" id="tpl-collaborator-list-item">
        <a href="<%=html_url%>" >
            <img src="<%=avatar_url%>" title="<%=name||login%>"/>
        </a>
	</script>

	<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.3.1/underscore-min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/0.9.1/backbone-min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/galleria/1.2.6/galleria.min.js"></script>
	<script src="lib/githubApiV3.js"></script>
	<script src="lib/github.js"></script>

	<script type="text/javascript">
		function MergeCommit( branches ){
			this.toMerge = branches.length;
			this.nbReceived = 0; 
			this.received = [];
		}
	
		(function ($) {
			window.Repository = Backbone.Model.extend();
			window.RepositoryCollection = Backbone.Collection.extend({ model:Repository });
			
			window.Collaborator = Backbone.Model.extend();
			window.CollaboratorCollection = Backbone.Collection.extend({ model:Collaborator });
			
			window.RepositoryResultView = Backbone.View.extend({
				el: $('#resultTitle'),
				render: function(eventName){
					$(this.el).text( _.template($('#tpl-repository-resultats').html(), this.model) );
				}
			});
			 
			window.RepositoryListView = Backbone.View.extend({
				el: $('#resultDiv'),
				tagName: 'ul',
				
				initialize:function () {
			        this.model.bind("reset", this.render, this);
				},

				render:function (eventName) {
				    _.each(this.model.models, function (repository) {
				        $(this.el).append(new RepositoryListItemView({model:repository}).render().el);
				    }, this);
		   			return this;
				}
			});


			window.RepositoryListItemView = Backbone.View.extend({
				tagName: 'li',
				className: 'repository',				

				events:{
					"click" : "showDetails",
				},

				render:function (eventName) {
				    $(this.el).html( _.template($('#tpl-repository-list-item').html(), this.model.toJSON()) );
			        return this;
				},

				showDetails: function( event ){
					function loadBranches( response ){
					    console.log( response );
						this.collaborateurCollection = new CollaboratorCollection( response.map( function( element ) { return new Collaborator( element ) } ) );
						this.collaboratorListView = new CollaboratorListView({model:this.collaborateurCollection});
						this.collaboratorListView.render();
					}
					
					if( !$(event.target).is("a") ){
						var repo = gh3.repo(this.model.get("owner"), this.model.get("name"));
						repo.collaboratorsDetailed( window, loadBranches );
					}
				},
			});
			
			window.CollaboratorListView = Backbone.View.extend({
				el: $('#resultCollaborator'),
				
				initialize:function () {
			        //this.model.bind("reset", this.render, this);
				},

				render:function (eventName) {
				    $(this.el).empty();
				    _.each(this.model.models, function ( collaborator ) {
				        $(this.el).append( _.template($('#tpl-collaborator-list-item').html(), collaborator.toJSON() ) );
				    }, this);
		   			return this;
				}
			});

			window.AppView = Backbone.View.extend({
	  			el: $("body"),
				idResultTitle : '#resultTitle',
				idResultDiv : '#resultDiv',
				idDisplayInfo : '#displayInfo',
				idRepoTitle : '#repoTitle',

	  			events: {
	  	 	 		"change #repoTitle":  "showPrompt",
	 	 		},
				
				initialize:function () {
					var repoTitle = $(this.idRepoTitle);
					repoTitle.val('');
					repoTitle.focus();
				},
				
	  			showPrompt: function ( event ) {
					function displayResult( repoName, repositories ){
						console.log(repositories );						
						
						$('#resultTitle').text( );
						this.repositoryResultView = new RepositoryResultView( {model:{name:repoName, nbResultats: repositories.length } } );
						this.repositoryResultView.render();

						if( repositories.length > 0 ){
							console.log( this );
							this.repositoryCollection = new RepositoryCollection( repositories.map( function( element ) { return new Repository( element ) } ) );
							this.repositoryListView = new RepositoryListView({model:this.repositoryCollection});
							console.log( this );
							this.repositoryListView.render();
						}
					};
					var repoName = this.reset( event );
					if( repoName && repoName.length > 0 ){
						gh.repo.search( repoName, this, function ( response ) { displayResult( repoName, response.repositories ) } );
					}
				},

				reset: function( event ){
					$(this.idResultTitle).empty();
					$(this.idResultDiv).empty();
					//$(this.idDisplayInfo).empty();
					return $(event.target).val();
				}
			});
			var appview = new AppView;
		})(jQuery);
	</script>
</body>
</html>


